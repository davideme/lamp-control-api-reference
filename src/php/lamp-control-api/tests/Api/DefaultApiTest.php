<?php

/**
 * Lamp Control API
 * PHP version 8.1
 *
 * @package OpenAPIServer
 * @author  OpenAPI Generator team
 * @link    https://github.com/openapitools/openapi-generator
 */

/**
 * A simple API for controlling lamps, demonstrating CRUD operations.
 * The version of the OpenAPI document: 1.0.0
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */


/**
 * NOTE: This class is auto generated by the openapi generator program.
 * https://github.com/openapitools/openapi-generator
 * Please update the test case below to test the endpoint.
 */

namespace OpenAPIServer\Api;

use OpenAPIServer\Api\DefaultApi;
use OpenAPIServer\Repository\LampRepository;
use OpenAPIServer\Service\LampService;
use PHPUnit\Framework\MockObject\MockObject;
use PHPUnit\Framework\TestCase;
use Slim\Psr7\Factory\StreamFactory;
use Slim\Psr7\Response;
use Slim\Psr7\Headers;
use Slim\Psr7\Request as SlimRequest;
use Slim\Psr7\Uri;

/**
 * DefaultApiTest Class Doc Comment
 *
 * @package OpenAPIServer\Api
 * @author  OpenAPI Generator team
 * @link    https://github.com/openapitools/openapi-generator
 *
 * @coversDefaultClass \OpenAPIServer\Api\DefaultApi
 */
class DefaultApiTest extends TestCase
{
    /** @var MockObject|LampRepository */
    private $mockRepo;

    /** @var MockObject|LampService */
    private $mockService;

    /** @var DefaultApi */
    private $api;

    private function createJsonRequest(string $method, string $path, array $body = null): SlimRequest
    {
        $uri = new Uri('', '', 80, $path);
        $headers = new Headers([
            'Content-Type' => ['application/json'],
            'Accept' => ['application/json'],
        ]);
        $cookies = [];
        $serverParams = [];
        $streamFactory = new StreamFactory();
        $stream = $streamFactory->createStream($body ? (json_encode($body) ?: '{}') : '');
        return new SlimRequest($method, $uri, $headers, $cookies, $serverParams, $stream);
    }

    /**
     * Setup before running any test cases
     */
    public static function setUpBeforeClass(): void {}

    /**
     * Setup before running each test case
     */
    public function setUp(): void
    {
        parent::setUp();
        $this->mockRepo = $this->getMockBuilder(LampRepository::class)
            ->onlyMethods(['create', 'all', 'get', 'update', 'delete'])
            ->getMock();
        $this->mockService = $this->getMockBuilder(LampService::class)
            ->disableOriginalConstructor()
            ->getMock();
        $this->api = $this->getMockBuilder(DefaultApi::class)
            ->onlyMethods(['__construct'])
            ->disableOriginalConstructor()
            ->getMock();
        // Inject the mock service into the DefaultApi instance
        $reflection = new \ReflectionClass(DefaultApi::class);
        $serviceProp = $reflection->getProperty('service');
        $serviceProp->setAccessible(true);
        $serviceProp->setValue($this->api, $this->mockService);
    }

    /**
     * Clean up after running each test case
     */
    public function tearDown(): void {}

    /**
     * Clean up after running all test cases
     */
    public static function tearDownAfterClass(): void {}

    /**
     * Test case for createLamp
     *
     * Create a new lamp.
     *
     * @covers ::createLamp
     */
    public function testCreateLamp(): void
    {
        $now = (new \DateTime())->format(\DateTime::ATOM);
        $lampData = ['id' => '1', 'status' => true, 'createdAt' => $now, 'updatedAt' => $now];
        $lampObj = $this->createMock(\OpenAPIServer\Model\Lamp::class);
        $lampObj->method('getData')->willReturn($lampData);
        $lampObj->method('jsonSerialize')->willReturn($lampData);
        $this->mockService->expects($this->once())
            ->method('create')
            ->willReturn($lampObj);
        $this->mockService->expects($this->once())
            ->method('all')
            ->willReturn([$lampObj]);
        $this->mockService->expects($this->exactly(2))
            ->method('get')
            ->withConsecutive(['1'], ['1'])
            ->willReturnOnConsecutiveCalls($lampObj, null);
        $this->mockService->expects($this->once())
            ->method('update')
            ->willReturnCallback(function ($id, $update) use ($now) {
                // Use a fixed timestamp that's clearly different from creation time
                $updatedNow = (new \DateTime('2025-08-28 20:30:00'))->format(\DateTime::ATOM);
                // createdAt should remain unchanged, only updatedAt should be modified
                $updatedData = ['id' => '1', 'status' => false, 'createdAt' => $now, 'updatedAt' => $updatedNow];
                $updatedLamp = $this->createMock(\OpenAPIServer\Model\Lamp::class);
                $updatedLamp->method('getData')->willReturn($updatedData);
                $updatedLamp->method('jsonSerialize')->willReturn($updatedData);
                return $updatedLamp;
            });
        $this->mockService->expects($this->once())
            ->method('delete')
            ->willReturn(true);

        // Create a request to create a lamp (status only, boolean)
        $request = $this->createJsonRequest('POST', '/lamps', ['status' => true]);
        $response = new Response();
        $response = $this->api->createLamp($request, $response);
        $this->assertEquals(201, $response->getStatusCode());
        $lamp = json_decode((string)$response->getBody(), true);
        $this->assertArrayHasKey('id', $lamp);
        $this->assertArrayHasKey('status', $lamp);
        $this->assertArrayHasKey('createdAt', $lamp);
        $this->assertArrayHasKey('updatedAt', $lamp);
        $this->assertTrue($lamp['status']);
        $lampId = $lamp['id'];

        // 2. List lamps - now expects paginated response
        $request = $this->createJsonRequest('GET', '/lamps');
        $response = new Response();
        $response = $this->api->listLamps($request, $response);
        $this->assertEquals(200, $response->getStatusCode());
        $paginatedResponse = json_decode((string)$response->getBody(), true);
        $this->assertArrayHasKey('data', $paginatedResponse);
        $this->assertArrayHasKey('hasMore', $paginatedResponse);
        $this->assertArrayHasKey('nextCursor', $paginatedResponse);
        $this->assertIsArray($paginatedResponse['data']);
        $this->assertNotEmpty($paginatedResponse['data']);
        $this->assertEquals($lampId, $paginatedResponse['data'][0]['id']);

        // 3. Get lamp
        $request = $this->createJsonRequest('GET', "/lamps/{$lampId}");
        $response = new Response();
        $response = $this->api->getLamp($request, $response, (string)$lampId);
        $this->assertEquals(200, $response->getStatusCode());
        $lampFetched = json_decode((string)$response->getBody(), true);
        $this->assertEquals($lampId, $lampFetched['id']);
        $this->assertTrue($lampFetched['status']);
        $this->assertArrayHasKey('createdAt', $lampFetched);
        $this->assertArrayHasKey('updatedAt', $lampFetched);

        // 4. Update lamp (turn off)
        $request = $this->createJsonRequest('PUT', "/lamps/{$lampId}", ['status' => false]);
        $response = new Response();
        $response = $this->api->updateLamp($request, $response, (string)$lampId);
        $this->assertEquals(200, $response->getStatusCode());
        $lampUpdated = json_decode((string)$response->getBody(), true);
        $this->assertFalse($lampUpdated['status']);
        $this->assertArrayHasKey('createdAt', $lampUpdated);
        $this->assertArrayHasKey('updatedAt', $lampUpdated);
        // Verify that createdAt remains unchanged during updates
        $this->assertEquals($lamp['createdAt'], $lampUpdated['createdAt']);
        // Verify that updatedAt is different (newer) than createdAt
        $this->assertNotEquals($lampUpdated['createdAt'], $lampUpdated['updatedAt']);

        // 5. Delete lamp
        $request = $this->createJsonRequest('DELETE', "/lamps/{$lampId}");
        $response = new Response();
        $response = $this->api->deleteLamp($request, $response, (string)$lampId);
        $this->assertEquals(204, $response->getStatusCode());

        // 6. Get deleted lamp (should 404)
        $request = $this->createJsonRequest('GET', "/lamps/{$lampId}");
        $response = new Response();
        $response = $this->api->getLamp($request, $response, (string)$lampId);
        $this->assertEquals(404, $response->getStatusCode());
    }
}

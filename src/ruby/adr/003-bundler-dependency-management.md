# ADR 003: Bundler as Dependency Manager and Build Tool

## Status

Accepted

## Context

The Ruby implementation of the Lamp Control API requires a robust dependency management and build system to handle:

- Gem installation and version management
- Development vs production dependency separation
- Reproducible builds across environments
- Version conflict resolution
- Integration with CI/CD pipelines
- Ruby version compatibility management
- Security vulnerability tracking

Available dependency management options for Ruby projects include:

1. **Bundler** - Standard Ruby dependency manager
2. **RubyGems directly** - Manual gem management
3. **rbenv-gemset** - Gemset management with rbenv
4. **RVM gemsets** - RVM-based dependency isolation
5. **Composer-style alternatives** - Third-party solutions

## Decision

We will use **Bundler** as our dependency manager and build orchestration tool for the Ruby implementation.

## Rationale

### Why Bundler?

1. **Ruby Standard**
   - De facto standard for Ruby dependency management
   - Bundled with Ruby installations (Ruby 2.6+)
   - Maintained by the Ruby team and community
   - Universal adoption across Ruby ecosystem

2. **Dependency Resolution**
   - Advanced dependency resolution algorithm
   - Semantic versioning support with flexible constraints
   - Automatic conflict resolution and version selection
   - Transitive dependency management

3. **Environment Isolation**
   - Application-specific dependency isolation
   - Separate development, test, and production dependencies
   - Reproducible builds with lock files
   - Version pinning for stability

4. **Development Workflow**
   - Simple command-line interface
   - Integration with popular Ruby frameworks (Rails, Sinatra, etc.)
   - Built-in security audit capabilities
   - Easy dependency updates and maintenance

5. **CI/CD Integration**
   - Deterministic installs with `bundle install --deployment`
   - Cache-friendly for continuous integration
   - Cross-platform compatibility
   - Integration with deployment tools

6. **Security and Maintenance**
   - Vulnerability scanning with `bundle audit`
   - Automatic security updates
   - Gem verification and integrity checking
   - Private gem source support

## Project Configuration

### Gemfile Structure
```ruby
# frozen_string_literal: true

source 'https://rubygems.org'

# Specify Ruby version
ruby '3.2.0'

# Core application dependencies
gem 'sinatra', '~> 3.0'
gem 'puma', '~> 6.0'
gem 'rack', '~> 2.2'
gem 'json', '~> 2.6'

# Database and ORM
gem 'pg', '~> 1.4'
gem 'sequel', '~> 5.68'

# Development dependencies
group :development do
  gem 'rerun', '~> 0.14'
  gem 'rubocop', '~> 1.50', require: false
  gem 'rubocop-performance', require: false
  gem 'yard', '~> 0.9'
end

# Test dependencies
group :test do
  gem 'rspec', '~> 3.12'
  gem 'rack-test', '~> 2.1'
  gem 'simplecov', '~> 0.22', require: false
  gem 'webmock', '~> 3.18'
end

# Development and test
group :development, :test do
  gem 'pry', '~> 0.14'
  gem 'dotenv', '~> 2.8'
end
```

### Bundler Configuration (.bundle/config)
```yaml
---
BUNDLE_PATH: "vendor/bundle"
BUNDLE_DEPLOYMENT: "true"
BUNDLE_WITHOUT: "development:test"
BUNDLE_CLEAN: "true"
BUNDLE_NO_CACHE: "true"
```

### Lock File (Gemfile.lock)
- Automatically generated by Bundler
- Contains exact versions of all gems and dependencies
- Ensures reproducible builds across environments
- Must be committed to version control

## Development Workflow

### Basic Commands
```bash
# Install dependencies
bundle install

# Install without development/test groups
bundle install --without development test

# Update all gems
bundle update

# Update specific gem
bundle update sinatra

# Add a gem
bundle add gem_name

# Remove a gem
bundle remove gem_name

# Execute command in bundle context
bundle exec ruby app.rb
bundle exec rspec
bundle exec rubocop

# Show dependency tree
bundle viz

# Check for outdated gems
bundle outdated

# Audit for security vulnerabilities
bundle audit
```

### Development Environment Setup
```bash
# Install bundler if not present
gem install bundler

# Install project dependencies
bundle install

# Run application in development
bundle exec ruby app.rb

# Run tests
bundle exec rspec

# Run linter
bundle exec rubocop

# Generate documentation
bundle exec yard doc
```

## Dependency Categories

### Production Dependencies
```ruby
# Web framework and server
gem 'sinatra', '~> 3.0'
gem 'puma', '~> 6.0'

# Database and data handling
gem 'pg', '~> 1.4'
gem 'sequel', '~> 5.68'
gem 'json', '~> 2.6'

# Utilities and libraries
gem 'logger', '~> 1.5'
gem 'rack-cors', '~> 2.0'
```

### Development Dependencies
```ruby
group :development do
  gem 'rerun', '~> 0.14'          # Auto-restart on file changes
  gem 'rubocop', '~> 1.50'        # Code style and linting
  gem 'yard', '~> 0.9'            # Documentation generation
  gem 'bundler-audit', '~> 0.9'   # Security auditing
end
```

### Test Dependencies
```ruby
group :test do
  gem 'rspec', '~> 3.12'          # Testing framework
  gem 'rack-test', '~> 2.1'       # HTTP testing for Rack apps
  gem 'simplecov', '~> 0.22'      # Code coverage
  gem 'webmock', '~> 3.18'        # HTTP request stubbing
  gem 'factory_bot', '~> 6.2'     # Test data factories
end
```

## Alternatives Considered

### Direct RubyGems Management
**Pros:**
- No additional tools required
- Direct control over gem installations
- Simple for very basic projects

**Cons:**
- No dependency resolution or conflict management
- No environment isolation
- Manual version management
- No reproducible builds
- Security vulnerabilities difficult to track

### rbenv-gemset
**Pros:**
- Gemset isolation per project
- Works with rbenv for Ruby version management
- Lightweight approach

**Cons:**
- Additional plugin installation required
- Manual gemset management overhead
- No dependency resolution
- Limited adoption compared to Bundler

### RVM Gemsets
**Pros:**
- Integrated with RVM for Ruby version management
- Project-specific gem isolation
- Established workflow for some teams

**Cons:**
- RVM-specific, not portable to other Ruby managers
- Additional complexity in environment setup
- Manual dependency management
- Declining adoption in favor of Bundler

## Security and Vulnerability Management

### Security Auditing
```bash
# Install bundler-audit gem
gem install bundler-audit

# Update vulnerability database
bundle audit update

# Check for vulnerabilities
bundle audit check

# Check and update in one command
bundle audit
```

### Best Practices
1. **Regular Updates**
   - Update gems regularly but test thoroughly
   - Use `bundle outdated` to check for updates
   - Update security patches immediately

2. **Version Constraints**
   - Use pessimistic version constraints (`~>`)
   - Pin major versions for stability
   - Allow minor and patch updates

3. **Security Monitoring**
   - Run `bundle audit` in CI/CD pipelines
   - Set up automated security notifications
   - Monitor Ruby security advisories

## CI/CD Integration

### Deployment Commands
```bash
# Install dependencies for production
bundle install --deployment --without development test

# Precompile if using Rails-style asset pipeline
bundle exec rake assets:precompile

# Run application
bundle exec ruby app.rb
```

### CI Configuration Example
```yaml
# .github/workflows/ruby.yml
name: Ruby CI
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.2.0
        bundler-cache: true
    - run: bundle exec rspec
    - run: bundle exec rubocop
    - run: bundle audit check --update
```

## Performance Optimization

### Bundle Configuration
```bash
# Configure parallel installation
bundle config set --local jobs 4

# Use local vendor directory
bundle config set --local path 'vendor/bundle'

# Clean unused gems
bundle config set --local clean true

# Disable gem cache
bundle config set --local no-cache true
```

### Caching Strategies
```bash
# Cache gems in CI/CD
cache_key: bundle-${{ hashFiles('Gemfile.lock') }}

# Vendor bundle for Docker
COPY Gemfile Gemfile.lock ./
RUN bundle install --deployment --without development test
```

## Consequences

### Positive
- **Standard Practice**: Industry-standard approach familiar to all Ruby developers
- **Reproducible Builds**: Lock files ensure consistent environments
- **Security**: Built-in vulnerability scanning and monitoring
- **Ecosystem**: Full access to RubyGems ecosystem
- **Integration**: Seamless integration with Ruby frameworks and tools
- **Performance**: Efficient dependency resolution and installation

### Negative
- **Ruby Dependency**: Requires Ruby runtime environment
- **Lock File Management**: Gemfile.lock conflicts in team development
- **Bundle Exec**: Need to prefix commands with `bundle exec`

### Neutral
- **Learning Curve**: Minimal for Ruby developers
- **Configuration**: Simple but requires understanding of groups and constraints

## Future Considerations

1. **Gem Authoring**
   - Potential for creating internal gems for shared code
   - Gem publishing and versioning strategies

2. **Alternative Gem Sources**
   - Private gem servers for proprietary dependencies
   - Git-based gem sources for development

3. **Performance Improvements**
   - Parallel gem installation optimization
   - Docker layer caching strategies
   - Bundler 3.0+ features adoption

4. **Security Enhancements**
   - Automated dependency updates with testing
   - Gem signature verification
   - Private vulnerability databases

## References

- [Bundler Documentation](https://bundler.io/)
- [RubyGems Guide](https://guides.rubygems.org/)
- [Bundler Best Practices](https://bundler.io/guides/best_practices.html)
- [Ruby Security Guide](https://guides.rubyonrails.org/security.html)
- [Semantic Versioning](https://semver.org/)

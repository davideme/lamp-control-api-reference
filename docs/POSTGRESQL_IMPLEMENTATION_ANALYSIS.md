# PostgreSQL Implementation Analysis

A feature-based comparison of PostgreSQL implementations across all 6 languages in the Lamp Control API Reference project.

---

## Quick Reference Matrix

| Feature | Java | Kotlin | Python | Go | C# | TypeScript |
|---------|------|--------|--------|----|----|------------|
| **ORM/Driver** | Hibernate | Exposed | SQLAlchemy | pgx + sqlc | EF Core | Prisma |
| **Query Style** | Implicit | DSL | Explicit | Raw SQL | Implicit | Implicit |
| **Migration Format** | SQL | SQL | Python + SQL | SQL | C# | SQL |
| **Schema Definition** | Annotations | Code DSL | Code | SQL | Fluent API | Schema DSL |
| **Async Support** | No | Coroutines | asyncio | Context | async/await | Promise |
| **Soft Delete Filter** | Automatic | Manual | Manual | Manual | Automatic | Manual |
| **Timestamp Handling** | ORM | DB Trigger | DB Trigger | DB Trigger | DB Trigger | ORM |

---

## 1. Query Approach

How queries are constructed and executed.

| Language | Approach | Description |
|----------|----------|-------------|
| **Java** | Implicit (Method Names) | Queries derived from method names like `findByStatus()` or `@Query` annotations |
| **Kotlin** | DSL (Type-safe) | Kotlin DSL: `LampsTable.selectAll().where { deletedAt.isNull() }` |
| **Python** | Explicit (ORM) | SQLAlchemy select(): `select(LampModel).where(LampModel.id == id)` |
| **Go** | Raw SQL | Hand-written SQL in `.sql` files, code generated by sqlc |
| **C#** | Implicit (LINQ) | LINQ queries: `context.Lamps.FirstOrDefaultAsync(l => l.Id == id)` |
| **TypeScript** | Implicit (Client) | Prisma Client: `prisma.lamp.findUnique({ where: { id } })` |

### Query Style Categories

- **Implicit/Magic**: Java (Spring Data), C# (EF Core), TypeScript (Prisma) - framework generates queries from method calls
- **Explicit DSL**: Kotlin (Exposed), Python (SQLAlchemy) - developer builds queries using type-safe builders
- **Raw SQL**: Go (sqlc) - developer writes SQL, tool generates type-safe code

---

## 2. Schema Definition

How the database schema is defined in application code.

| Language | Approach | Location |
|----------|----------|----------|
| **Java** | Annotations on Entity | `@Entity`, `@Table`, `@Column` on class fields |
| **Kotlin** | Table Object DSL | `object LampsTable : Table("lamps") { val id = uuid("id") }` |
| **Python** | Mapped Columns | `id: Mapped[UUID] = mapped_column(PGUUID, primary_key=True)` |
| **Go** | No Schema in Code | Schema lives only in SQL migration files |
| **C#** | Fluent API in DbContext | `entity.Property(e => e.IsOn).HasColumnName("is_on")` |
| **TypeScript** | Prisma Schema DSL | `model Lamp { id String @id @db.Uuid }` in `.prisma` file |

### Schema Definition Categories

- **Code-First**: Java, Python, C# - schema derived from code definitions
- **Schema-First**: Go - schema defined in SQL, code generated
- **Dedicated DSL**: Kotlin (Exposed), TypeScript (Prisma) - specialized schema language

---

## 3. Migration Format

How database migrations are written and managed.

| Language | Tool | Format | Reversible | Generated From |
|----------|------|--------|------------|----------------|
| **Java** | Flyway | Pure SQL | Manual rollback | Hand-written |
| **Kotlin** | Flyway | Pure SQL | Manual rollback | Hand-written |
| **Python** | Alembic | Python code (executes SQL) | Auto-generated | Hand-written or auto |
| **Go** | golang-migrate | Pure SQL (up/down pairs) | Yes | Hand-written |
| **C#** | EF Core Migrations | C# code (MigrationBuilder) | Yes | Auto-generated from model |
| **TypeScript** | Prisma Migrate | Pure SQL | Yes | Auto-generated from schema |

### Migration Categories

- **SQL-based**: Java, Kotlin, Go, TypeScript - migrations written as SQL files
- **Code-based**: Python, C# - migrations written in programming language
- **Auto-generated**: C# (from model changes), TypeScript (from schema changes)
- **Manual**: Java, Kotlin, Go, Python - developer writes migration content

---

## 4. Soft Delete Implementation

How soft deletes are filtered from queries.

| Language | Filter Type | Mechanism |
|----------|-------------|-----------|
| **Java** | Automatic (Global) | `@Where(clause = "deleted_at IS NULL")` on entity class |
| **Kotlin** | Manual (Per Query) | Must add `.where { deletedAt.isNull() }` to each query |
| **Python** | Manual (Per Query) | Must add `.where(LampModel.deleted_at.is_(None))` to each query |
| **Go** | Manual (Per Query) | Must include `WHERE deleted_at IS NULL` in each SQL query |
| **C#** | Automatic (Global) | `entity.HasQueryFilter(e => e.DeletedAt == null)` in DbContext |
| **TypeScript** | Manual (Per Query) | Must add `where: { deletedAt: null }` to each Prisma query |

### Soft Delete Categories

- **Automatic Filtering**: Java, C# - deleted records automatically excluded from all queries
- **Manual Filtering**: Kotlin, Python, Go, TypeScript - developer must remember to filter in each query

---

## 5. Timestamp Management

How `created_at` and `updated_at` fields are handled.

| Language | created_at | updated_at |
|----------|-----------|------------|
| **Java** | `@CreationTimestamp` (ORM) | `@UpdateTimestamp` (ORM) |
| **Kotlin** | Application code | Database trigger |
| **Python** | Application code | Database trigger |
| **Go** | Application code | Database trigger |
| **C#** | Database default | Database trigger |
| **TypeScript** | `@default(now())` (Prisma) | `@updatedAt` (Prisma) |

### Timestamp Categories

- **ORM-managed**: Java, TypeScript - ORM handles timestamp logic
- **Trigger-managed**: Kotlin, Python, Go, C# - PostgreSQL trigger updates `updated_at`
- **Hybrid**: Some use DB defaults for `created_at`, triggers for `updated_at`

---

## 6. Connection Pooling

How database connections are managed.

| Language | Pool Library | Configurable | Approach |
|----------|--------------|--------------|----------|
| **Java** | HikariCP | Yes (env vars) | Explicit configuration |
| **Kotlin** | HikariCP | Yes (env vars) | Explicit configuration |
| **Python** | SQLAlchemy pool | Yes (env vars) | Explicit configuration |
| **Go** | pgxpool | Limited | Mostly defaults |
| **C#** | Npgsql (internal) | Limited | Framework-managed |
| **TypeScript** | Prisma (internal) | No | Fully managed by Prisma |

### Pool Configuration Categories

- **Explicit**: Java, Kotlin, Python - developer configures pool size, timeouts, etc.
- **Framework-managed**: Go, C#, TypeScript - framework handles pooling with minimal config

---

## 7. Async/Concurrency Model

How concurrent database operations are handled.

| Language | Model | Keywords |
|----------|-------|----------|
| **Java** | Synchronous | Blocking calls, thread pool |
| **Kotlin** | Coroutines | `suspend fun`, `newSuspendedTransaction` |
| **Python** | asyncio | `async def`, `await`, `AsyncSession` |
| **Go** | Context-based | `context.Context` for cancellation/timeout |
| **C#** | async/await | `async Task`, `await`, `ToListAsync()` |
| **TypeScript** | Promises | `async/await`, `Promise<T>` |

### Async Categories

- **Truly Async**: Kotlin, Python, TypeScript - non-blocking I/O
- **Context-aware**: Go - cancellation and timeout support
- **Async Wrapper**: C# - async/await over potentially blocking calls
- **Synchronous**: Java - blocking operations (async requires WebFlux)

---

## 8. Type Safety Level

How the database layer ensures type correctness.

| Language | Compile-time Safety | Runtime Safety |
|----------|---------------------|----------------|
| **Java** | Medium (annotations) | High (Hibernate validation) |
| **Kotlin** | High (DSL types) | High (Exposed validation) |
| **Python** | Medium (type hints) | Medium (runtime checks) |
| **Go** | High (generated code) | High (sqlc generates typed structs) |
| **C#** | High (LINQ expressions) | High (EF Core validation) |
| **TypeScript** | High (generated types) | High (Prisma generates types) |

### Type Safety Categories

- **Generated Types**: Go (sqlc), TypeScript (Prisma) - types generated from schema
- **DSL Types**: Kotlin (Exposed) - type-safe query builders
- **ORM Types**: Java, C#, Python - types from entity/model definitions

---

## 9. Field Mapping (Domain vs Database)

How field names differ between domain model and database.

| Language | Domain Field | Database Column | Mapping Approach |
|----------|--------------|-----------------|------------------|
| **Java** | `status` | `is_on` | `@Column(name = "is_on")` |
| **Kotlin** | `status` | `is_on` | Manual in repository |
| **Python** | `status` | `is_on` | Manual in repository |
| **Go** | `Status` | `is_on` | sqlc struct tags |
| **C#** | `Status` | `is_on` | Manual in repository |
| **TypeScript** | `status` | `is_on` | `@map("is_on")` in schema |

All implementations map domain concept `status` (boolean: lamp on/off) to database column `is_on`.

---

## 10. Error Handling

How database errors are translated to domain errors.

| Language | Approach | Not Found Handling |
|----------|----------|-------------------|
| **Java** | Spring translates to DataAccessException | Returns `Optional.empty()` |
| **Kotlin** | Returns null | `singleOrNull()` returns null |
| **Python** | Raises `LampNotFoundError` | Custom exception class |
| **Go** | Returns `ErrLampNotFound` | Sentinel error value |
| **C#** | Returns null | `FirstOrDefaultAsync` returns null |
| **TypeScript** | Throws `LampNotFoundError` | Catches Prisma P2025 error |

### Error Handling Categories

- **Null-based**: Java, Kotlin, C# - return null/empty for not found
- **Exception-based**: Python, TypeScript - throw custom domain exceptions
- **Sentinel errors**: Go - return predefined error values

---

## Summary Comparison

### Most Explicit Control
1. **Go** - Raw SQL, manual everything, maximum control
2. **Kotlin** - DSL queries, manual filters, explicit config
3. **Python** - Explicit ORM queries, manual filters

### Most Magic/Convention
1. **Java** - Method name queries, auto soft-delete filter, ORM timestamps
2. **C#** - LINQ queries, global query filters, auto-generated migrations
3. **TypeScript** - Prisma client, generated migrations, managed pooling

### Best Type Safety
1. **Go** (sqlc) - Compile-time SQL validation, generated types
2. **TypeScript** (Prisma) - Generated client with full type coverage
3. **Kotlin** (Exposed) - Type-safe DSL at compile time

### Best Async Support
1. **Python** - Native asyncio with asyncpg driver
2. **Kotlin** - Coroutines with suspended transactions
3. **TypeScript** - Promise-based with async/await

---

## References

- [ADR 005: PostgreSQL Storage Support](adr/005-postgresql-storage-support.md)
- [PostgreSQL Schema](../database/sql/postgresql/schema.sql)
